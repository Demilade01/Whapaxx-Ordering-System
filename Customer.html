<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Whapaxx — Order</title>
<style>
  :root{
    --bg:#0b1247; --card:#1a1f5c; --text:#fff; --muted:#c7c9e0;
    --accent:#e52b39;               /* red-orange */
    --accent-hover:#c0212c;         /* darker hover */
    --accent-border:#951821;        /* darkest border for contrast */
    --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.25);
    --lineA:rgba(255,255,255,.06); --lineB:rgba(255,255,255,.04);
    --chip-bg:#0f156a; --chip-border:#4050e0; --chip-on:#e52b39;
  }
  *{box-sizing:border-box}
  body{
    margin:0;color:var(--text);
    background:radial-gradient(1200px 600px at 10% -10%, #16217a 0%, #0b1247 60%), #0b1247;
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    padding:14px; padding-top:60px;
  }

  /* Fixed cart button (top-right) — #e52b39 */
  .cartBtn{
    position:fixed; right:14px; top:10px; z-index:1000;
    display:inline-flex; align-items:center; gap:8px;
    background: var(--accent); color:#fff; border:none;
    border-radius:999px; padding:10px 14px; font-weight:800; font-size:16px;
    backdrop-filter:blur(6px); cursor:pointer; transition:background .15s ease;
  }
  .cartBtn:hover{ background: var(--accent-hover); }
  .cartIcon{width:18px;height:18px;display:inline-block}

  /* Layout */
  .wrap{max-width:1400px;margin:0 auto}
  .grid{display:grid; gap:14px; grid-template-columns:1fr;}
  @media (min-width: 820px){ .grid{grid-template-columns:1fr 1fr;} }
  @media (min-width: 1180px){ .grid{grid-template-columns:1fr 1fr 1fr;} }

  /* Item card */
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
  .thumb{width:100%; aspect-ratio:16/9; display:block; object-fit:cover; pointer-events:none; background:#0f156a; border-bottom:1px solid #2b3297;}
  .body{padding:12px}
  .title{margin:0 0 6px;font-size:1.08rem}
  .muted{color:var(--muted)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}

  /* Variation chips (visible; variation required when present) */
  .chip{
    padding:6px 10px;border-radius:999px;border:1px solid var(--chip-border);
    background:var(--chip-bg); color:#fff; cursor:pointer; font-size:16px
  }
  .chip.on{
    background:var(--chip-on); color:#fff; border-color:var(--accent-border);
  }

  /* Quantity controls — bigger, spaced */
  .qtyCtl{
    margin-left:auto; display:flex; align-items:center; gap:10px;
  }
  .qtyCtl button{
    font-size:22px !important; padding:12px 18px; min-width:44px; min-height:44px;
  }
  .qtyCtl span{
    font-size:20px; min-width:36px; text-align:center; display:inline-block;
  }

  .btn{
    background:var(--accent); color:#fff; border:none; border-radius:12px;
    padding:10px 12px; font-weight:800; cursor:pointer; font-size:16px; transition:background .15s ease;
  }
  .btn:hover{ background:var(--accent-hover); }
  .ghost{background:transparent;border:1px dashed #5760d6;color:#cbd0ff; font-size:16px}
  .addBtn{width:100%;margin-top:10px}

  /* Centered CART modal */
  .drawer{position:fixed;inset:0;display:none;z-index:2000;align-items:center;justify-content:center;background:rgba(0,0,0,.45)}
  .drawer.show{display:flex}
  .sheet{
    background:#0e1358;border:1px solid #2b3297;border-radius:16px;max-width:820px;width:92vw;
    max-height:88vh;overflow:auto;padding:14px
  }
  .sheet h3{margin:2px 0 10px}
  .field{display:grid;gap:6px;margin:10px 0}
  .field input{padding:12px;border-radius:10px;border:1px solid #3941a2;background:#141a69;color:#fff;font-size:16px}
  .lines{display:grid;gap:8px;margin-top:8px}
  .lineItem{display:grid;grid-template-columns:1fr auto;align-items:center;gap:8px;padding:10px;border-radius:12px}
  .lineItem:nth-child(odd){background:var(--lineA)}
  .lineItem:nth-child(even){background:var(--lineB)}
  .prodTitle{font-weight:800;font-size:1.02rem}
  .amt{font-weight:800}
  .cond{grid-column:1/-1;color:var(--muted);margin-top:2px}
  .addonTag{grid-column:1/-1;display:inline-block;font-size:.8rem;background:#0f1a7a;border:1px solid #3039a4;
            padding:2px 8px;border-radius:999px;margin-bottom:4px;color:#cbd0ff}
  .totalRow{display:flex;justify-content:space-between;gap:8px;font-weight:900;border-top:1px solid #2b3297;margin-top:10px;padding-top:8px;font-size:1.05rem}
  .actions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
  .closeX{background:transparent;border:0;color:#fff;font-size:18px;cursor:pointer}

  /* Options Modal (reused for add-ons & condiments) */
  .backdrop{position:fixed;inset:0;display:none;z-index:3000;align-items:center;justify-content:center;background:rgba(0,0,0,.5)}
  .backdrop.show{display:flex}
  .modal{background:#0e1358;border:1px solid #2b3297;border-radius:16px;max-width:600px;width:92vw;padding:14px}
  .modal h4{margin:0 0 8px}
  .subtle{color:var(--muted);font-size:.95rem;margin-bottom:8px}
  .gridChips{display:flex;flex-direction:column;gap:10px;margin:8px 0}
  .addonRow{
    display:grid; grid-template-columns:1fr auto; align-items:center; gap:10px;
    background:rgba(255,255,255,.04); border:1px solid #2b3297; border-radius:12px; padding:10px;
  }
  .addonTitle{font-weight:700}
  .qtyCtlSm{display:flex; align-items:center; gap:8px;}
  .qtyCtlSm button{font-size:20px !important; padding:10px 14px; min-width:44px; min-height:44px;}
  .qtyCtlSm span{font-size:18px; min-width:32px; text-align:center; display:inline-block;}
  .mActions{display:flex;gap:8px;justify-content:space-between;margin-top:10px}
  .leftActions{display:flex;gap:8px}
  .rightActions{display:flex;gap:8px}
  .mActions .btn, .mActions .ghost, #modalBack, #modalCancel, #modalOk, #modalNext, #modalSkip { font-size:16px; }

  /* Toast (centered) */
  .toast{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%) scale(.95);opacity:0;z-index:4000;
         background:#fff;color:#0b1247;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.25);padding:16px 18px;
         font-weight:900;min-width:260px;text-align:center;display:none}
  .toast.show{display:block;animation:toastIn .2s ease forwards}
  @keyframes toastIn{to{transform:translate(-50%,-50%) scale(1);opacity:1}}

  /* Pay-at-counter icon */
  .payIcon{width:20px;height:20px;object-fit:contain;display:inline-block;vertical-align:middle}

  /* ===== Kitchen-Closed FULLSCREEN overlay ===== */
  .kitchenClosedOverlay{
    position:fixed; inset:0; z-index:9999;
    display:none; align-items:center; justify-content:center; text-align:center;
    background:linear-gradient(180deg, #0b1247 0%, #101661 100%);
    color:#fff; padding:24px;
  }
  .kitchenClosedOverlay.show{ display:flex; }
  .kc-card{
    max-width:720px; width:min(92vw,720px);
    background:#121a73; border:1px solid #2b3297; border-radius:20px;
    box-shadow:0 24px 80px rgba(0,0,0,.35);
    padding:28px 24px;
  }
  .kc-title{ font-size:2.2rem; line-height:1.15; margin:0 0 6px; color:#fff; font-weight:900; }
  .kc-sub{ font-size:1.1rem; color:#c7c9e0; margin:0 0 14px; }
  .kc-next{
    margin-top:12px; font-weight:800; color:#fff; background:#0e7f4f;
    display:inline-block; padding:10px 14px; border-radius:999px; border:1px solid #0a6a42;
  }
  .kc-brand{ margin-top:18px; font-weight:900; color:#fff; display:inline-flex; align-items:center; gap:8px; }
  .kc-brand .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);display:inline-block}
  .kc-btn{
    margin-top:18px;
    background:#ffffff; color:#0b1247; border:none; border-radius:12px; padding:12px 16px;
    font-size:16px; font-weight:900; cursor:pointer; min-height:44px;
  }
</style>
</head>
<body>

<!-- ===== Kitchen Closed Overlay (full-screen) ===== -->
<div id="kitchenClosed" class="kitchenClosedOverlay" aria-live="polite" role="status">
  <div class="kc-card">
    <h1 class="kc-title">Kitchen Closed</h1>
    <p class="kc-sub">We’re not accepting orders right now.</p>
    <div id="nextOpen" class="kc-next" style="display:none"></div>
    <div class="kc-brand"><span class="dot"></span> Whapaxx</div>
    <button class="kc-btn" onclick="location.reload()">Refresh</button>
  </div>
</div>

<!-- Wrap all app UI so we can hide/disable it when closed -->
<div id="appRoot" aria-hidden="false">
  <button id="cartBtn" class="cartBtn" type="button" aria-haspopup="dialog">
    <svg class="cartIcon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M3 3h2l2.2 10.4a2 2 0 0 0 2 1.6h7.7a2 2 0 0 0 2-1.6L21 7H7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <circle cx="9" cy="20" r="1.75" fill="currentColor"/>
      <circle cx="18" cy="20" r="1.75" fill="currentColor"/>
    </svg>
    Cart (<span id="cartCount">0</span>)
  </button>

  <div class="wrap">
    <section class="grid" id="menu"></section>
  </div>

  <!-- Centered Cart Modal -->
  <div class="drawer" id="cartDrawer" aria-modal="true" role="dialog">
    <div class="sheet" role="document">
      <div style="display:flex;align-items:center;gap:8px">
        <h3 style="margin:0">Your Cart</h3>
        <button class="closeX" id="closeCart" title="Close">✕</button>
      </div>
      <div class="field">
        <label for="custName">Your Name (required)</label>
        <input id="custName" placeholder="e.g. Taylor" autocomplete="off" />
      </div>
      <div id="cartLines" class="lines"></div>
      <div class="totalRow"><div>Total</div><div id="cartTotal">$0.00</div></div>
      <div class="actions">
        <button id="clearCart" class="ghost">Clear</button>
        <button id="submitOrder" class="btn">
          <img class="payIcon" alt="" src="https://whapaxxgaming.com/wp-content/uploads/2025/08/IMG_0665-scaled.png" />
          &nbsp;Submit — Pay at Counter
        </button>
      </div>
    </div>
  </div>

  <!-- Options Modal (Add-ons / Condiments) -->
  <div class="backdrop" id="modal">
    <div class="modal">
      <h4 id="modalTitle">Choose Options</h4>
      <div id="modalSub" class="subtle"></div>
      <div id="modalChips" class="gridChips"></div>
      <div class="mActions">
        <div class="leftActions">
          <button id="modalBack" class="ghost" style="display:none">Back</button>
          <button id="modalCancel" class="ghost">Cancel</button>
        </div>
        <div class="rightActions">
          <button id="modalSkip" class="ghost" style="display:none">Skip</button>
          <button id="modalOk" class="btn">Done</button>
          <button id="modalNext" class="btn" style="display:none">Next</button>
        </div>
      </div>
    </div>
  </div>
</div> <!-- /#appRoot -->

<!-- Toast -->
<div class="toast" id="toast">Order Submitted — Pay at Counter</div>

<script>
/* ===== Hours gating (reads Admin Opening Hours) ===== */
const HOURS_KEY = 'whapaxx_hours_v1';

function loadHours(){
  try{
    const v = JSON.parse(localStorage.getItem(HOURS_KEY));
    return Array.isArray(v) ? v : [];
  }catch{ return []; }
}

function isKitchenOpen(hours, at=new Date()){
  if(!hours.length) return true; // default open if not configured yet
  const idx = at.getDay(); // 0..6
  const today = hours[idx];
  if(!today || !today.enabled) return false;
  const [oh,om] = String(today.open||'00:00').split(':').map(Number);
  const [ch,cm] = String(today.close||'00:00').split(':').map(Number);
  const start = new Date(at); start.setHours(oh,om,0,0);
  const end   = new Date(at); end.setHours(ch,cm,0,0);
  return at >= start && at <= end;
}

function findNextOpen(hours, at=new Date()){
  if(!hours.length) return null;
  for(let i=0;i<7;i++){
    const d = new Date(at);
    d.setDate(at.getDate()+i);
    const idx = d.getDay();
    const row = hours[idx];
    if(row && row.enabled){
      const [oh,om] = String(row.open||'00:00').split(':').map(Number);
      const openT = new Date(d); openT.setHours(oh,om,0,0);
      const dayShort = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][idx];
      if(i>0 || at < openT){
        const hh = String(openT.getHours()).padStart(2,'0');
        const mm = String(openT.getMinutes()).padStart(2,'0');
        return { dayLabel: i===0 ? 'Today' : dayShort, time: `${hh}:${mm}` };
      }
    }
  }
  return null;
}

function applyKitchenOpenState(){
  const hours = loadHours();
  const open = isKitchenOpen(hours);
  const overlay = document.getElementById('kitchenClosed');
  const app = document.getElementById('appRoot');
  const next = document.getElementById('nextOpen');

  if(open){
    overlay.classList.remove('show');
    overlay.setAttribute('aria-hidden','true');
    app.style.filter = '';
    app.style.pointerEvents = '';
    app.setAttribute('aria-hidden','false');
  }else{
    const nx = findNextOpen(hours);
    if(nx){
      next.style.display = 'inline-block';
      next.textContent = `Next opens: ${nx.dayLabel} ${nx.time}`;
    }else{
      next.style.display = 'none';
    }
    overlay.classList.add('show');
    overlay.setAttribute('aria-hidden','false');
    app.style.filter = 'blur(2px)';
    app.style.pointerEvents = 'none';
    app.setAttribute('aria-hidden','true');
  }
}

/* Initial check + live updates every 60s */
applyKitchenOpenState();
setInterval(applyKitchenOpenState, 60000);

/* ===== Your existing page logic ===== */
const ORDERS_KEY='whapaxx_orders_v2';

/* Menu (alphabetical); Bacon first for Fries a La Whapaxx & Mexi-Frag Fries */
const MENU = [
  {id:'bajan-bom-bites', title:'Bajan Bom Bites', price:10.95,
    image:'https://whapaxxgaming.com/wp-content/uploads/2025/08/IMG_0596.jpeg'},
  {id:'burger-royale', title:'Burger Royale', price:15.95,
    image:'https://whapaxxgaming.com/wp-content/uploads/2025/08/IMG_0592.jpeg',
    condiments:true, condimentOptions:['Cheese','Lettuce','Tomato','Mustard','Ketchup','Pepper','Honey Mustard']},
  {id:'fries', title:'Fries', price:11.95,
    image:'https://whapaxxgaming.com/wp-content/uploads/2025/08/IMG_0593.jpeg',
    addons:[{id:'tenders', title:'Tenders', price:17.95},{id:'wings',title:'Wings',price:17.95},{id:'fish',title:'Fish Sticks',price:16.95}]},
  {id:'fries-a-la-whapaxx', title:'Fries a La Whapaxx', price:25.95,
    image:'https://whapaxxgaming.com/wp-content/uploads/2025/08/IMG_0594-scaled.jpeg',
    variations:['Bacon','Chicken','Fish']},
  {id:'jumbo-dog-xp', title:'Jumbo Dog XP', price:11.95,
    image:'https://whapaxxgaming.com/wp-content/uploads/2025/08/IMG_0591-scaled.jpeg',
    condiments:true, condimentOptions:['Relish','Parmesan Cheese','Mustard','Ketchup','Honey Mustard'],
    addons:[{id:'combo-fries', title:'Combo Fries', price:7.95}]},
  {id:'mexi-frag-fries', title:'Mexi-Frag Fries', price:25.95,
    image:'https://whapaxxgaming.com/wp-content/uploads/2025/08/IMG_0598.webp',
    variations:['Bacon','Chicken','Fish']},
  {id:'pizza-power-ups', title:'Pizza Power-Ups', price:23.95,
    image:'https://whapaxxgaming.com/wp-content/uploads/2025/08/IMG_0590-scaled.jpeg',
    variations:['Pepperoni','Ham','Pepperoni + Pineapple','Ham + Pineapple','All Cheese']},
  {id:'snack-scroll-samosas', title:'Snack Scroll Samosas', price:19.95,
    image:'https://whapaxxgaming.com/wp-content/uploads/2025/08/IMG_0597.jpeg',
    variations:['Beef','Chicken','Sweet Chana','Vegetable'],
    addons:[{id:'sweet-chilli', title:'Sweet Chilli Sauce', price:0}]},
  {id:'whapaxx-wing-raid', title:'Whapaxx Wing Raid', price:26.95,
    image:'https://whapaxxgaming.com/wp-content/uploads/2025/08/IMG_0595-scaled.jpeg',
    variations:['Honey Mustard Sauce','BBQ Sauce','Sweet n Sour Sauce','Spicy Garlic Aioli','Ketchup'],
    addons:[{id:'combo-fries2', title:'Combo Fries', price:7.95}]},
];

/* ===== State ===== */
let cart=[];

/* ===== Helpers ===== */
const $ = s => document.querySelector(s);
const money = n => '$'+(Math.round(n*100)/100).toFixed(2);

/* Render helpers */
function lineHTML(i){
  const title = `<div class="prodTitle">${i.title} × ${i.qty}${i.variation?` <span class="muted">(${i.variation})</span>`:''}</div>`;
  const cond = (i.perItem && Array.isArray(i.perItem.condiments) && i.perItem.condiments.length)
    ? `<div class="cond"><strong>Condiments:</strong> ${i.perItem.condiments.join(', ')}</div>` : '';
  const tag = i.kind==='addon' ? `<span class="addonTag">Addon</span>` : '';
  return `<div class="lineItem">${tag}${title}<div class="amt">${money((i.unitPrice||0)*(i.qty||0))}</div>${cond}</div>`;
}
function renderCart(){
  $('#cartLines').innerHTML = cart.map(lineHTML).join('') || '<div class="muted">Your cart is empty.</div>';
  const total = cart.reduce((s,i)=>s+(i.unitPrice*i.qty),0);
  $('#cartTotal').textContent = money(total);
  $('#cartCount').textContent = cart.reduce((s,i)=>s+i.qty,0);
}

/* ===== Build Menu ===== */
function renderMenu(){
  const container = $('#menu'); container.innerHTML='';
  for(const m of MENU){
    const card=document.createElement('article'); card.className='card';
    const imgHTML = m.image ? `<img class="thumb" loading="lazy" src="${m.image}" alt="${m.title}">` : `<div class="thumb" aria-hidden="true"></div>`;
    card.innerHTML=`
      ${imgHTML}
      <div class="body">
        <h3 class="title">${m.title} <span class="muted">— ${money(m.price)}</span></h3>
        ${m.variations?`<div class="row" data-var><span class="muted">Variations:</span>
          ${m.variations.map(v=>`<button class="chip" data-v="${v}">${v}</button>`).join('')}
        </div>`:''}
        <div class="row">
          <div class="qtyCtl">
            <button class="ghost" data-minus="-">−</button>
            <span id="q-${m.id}">0</span>
            <button class="ghost" data-plus="+">+</button>
          </div>
        </div>
        <button class="addBtn btn" data-addcart="${m.id}">Add to Cart</button>
      </div>
    `;
    container.appendChild(card);

    /* per-card state */
    const varWrap = card.querySelector('[data-var]');
    let chosenVar = null;
    if(varWrap){
      varWrap.addEventListener('click', e=>{
        const b=e.target.closest('.chip'); if(!b) return;
        varWrap.querySelectorAll('.chip').forEach(x=>x.classList.remove('on'));
        b.classList.add('on'); chosenVar = b.dataset.v;
      });
    }

    let qty=0; const qEl=card.querySelector('#q-'+m.id);
    card.querySelector('[data-plus]')?.addEventListener('click', ()=>{ qty++; qEl.textContent=qty; });
    card.querySelector('[data-minus]')?.addEventListener('click', ()=>{ qty=Math.max(0,qty-1); qEl.textContent=qty; });

    /* Add to cart -> AUTO FLOW: Add-ons (if any, qty per add-on with Skip) -> Condiments (if required) */
    card.querySelector('[data-addcart]').addEventListener('click', async ()=>{
      if(qty<=0){ alert('Select a quantity first.'); return; }
      if(m.variations && (!chosenVar || chosenVar.trim()==='')){
        alert('Please select a variation first.');
        return;
      }

      // STEP 1: ADD-ONS (only if present) — returns [{id, qty}, ...] with qty>0
      let addonSelections = [];
      if(m.addons && m.addons.length){
        const pick = await openAddonsModal(m.addons, qty);
        if(pick === null) return;         // canceled
        addonSelections = pick;           // [] if skipped or all zeros
      }

      // STEP 2: CONDIMENTS per item (min 1 each) for required items
      let perItemSelections = null;
      if(m.condiments){
        perItemSelections = await openCondimentWizard(m.title, m.condimentOptions, qty);
        if(!perItemSelections) return; // canceled
      }

      // Add main items
      if(m.condiments){
        for(let i=0;i<qty;i++){
          cart.push({
            id:m.id, title:m.title, qty:1, unitPrice:m.price, variation:chosenVar||null,
            perItem:{index:i+1, condiments:[...perItemSelections[i]]}
          });
        }
      }else{
        cart.push({id:m.id, title:m.title, qty, unitPrice:m.price, variation:chosenVar||null});
      }

      // Add-on lines (use chosen qty per add-on)
      if(addonSelections && addonSelections.length){
        for(const sel of addonSelections){
          if(sel.qty>0){
            const add = m.addons.find(x=>x.id===sel.id);
            if(add) cart.push({id:add.id, title:add.title, qty:sel.qty, unitPrice:add.price, kind:'addon'});
          }
        }
      }

      // Reset qty
      qty=0; qEl.textContent='0';
      renderCart();
      showToast('Added to Cart', 1200);
    });
  }
}

/* ===== Options Modal elements ===== */
const modal=$('#modal'), modalTitle=$('#modalTitle'), modalSub=$('#modalSub'), chipsWrap=$('#modalChips');
const btnBack=$('#modalBack'), btnCancel=$('#modalCancel'), btnOk=$('#modalOk'), btnNext=$('#modalNext'), btnSkip=$('#modalSkip');

/* Add-ons modal with per-add-on quantity; max per add-on = main item qty
   Returns [{id, qty>0}, ...], [] if skipped, or null if canceled */
function openAddonsModal(addons, maxPer){
  return new Promise(resolve=>{
    modalTitle.textContent='Choose Add-ons';
    modalSub.textContent=`(Optional) Set quantities up to ${maxPer}. You can Skip.`;
    chipsWrap.innerHTML='';
    const rows = addons.map(a=>({ id:a.id, title:a.title, price:a.price, qty:0 }));

    for(const row of rows){
      const wrap = document.createElement('div');
      wrap.className = 'addonRow';
      wrap.innerHTML = `
        <div>
          <div class="addonTitle">${row.title}</div>
          <div class="subtle">+${money(row.price)} each</div>
        </div>
        <div class="qtyCtlSm">
          <button class="ghost" data-minus>-</button>
          <span data-val>0</span>
          <button class="ghost" data-plus>+</button>
        </div>
      `;
      const val = wrap.querySelector('[data-val]');
      wrap.querySelector('[data-plus]').addEventListener('click',()=>{
        row.qty = Math.min(maxPer, row.qty+1);
        val.textContent = row.qty;
      });
      wrap.querySelector('[data-minus]').addEventListener('click',()=>{
        row.qty = Math.max(0, row.qty-1);
        val.textContent = row.qty;
      });
      chipsWrap.appendChild(wrap);
    }

    btnBack.style.display='none';
    btnNext.style.display='none';
    btnOk.style.display='';
    btnSkip.style.display='';

    modal.classList.add('show');

    btnOk.onclick=()=>{ modal.classList.remove('show'); resolve(rows.filter(r=>r.qty>0).map(r=>({id:r.id, qty:r.qty}))); };
    btnSkip.onclick=()=>{ modal.classList.remove('show'); resolve([]); };
    btnCancel.onclick=()=>{ modal.classList.remove('show'); resolve(null); };
  });
}

/* Per-item wizard for condiments: min 1 each, returns Promise<array of arrays> or null */
function openCondimentWizard(itemTitle, options, qty){
  return new Promise((resolve)=>{
    let index=0;
    const picks = new Array(qty).fill(null).map(()=>new Set());

    function renderStep(){
      modalTitle.textContent = `Choose Condiments (min 1)`;
      modalSub.textContent = `${itemTitle} — Item ${index+1} of ${qty}`;
      chipsWrap.innerHTML='';
      const selected = picks[index];

      for(const opt of options){
        const b=document.createElement('button'); b.className='chip'; b.textContent=opt;
        if(selected.has(opt)) b.classList.add('on');
        b.addEventListener('click', ()=>{
          if(selected.has(opt)) selected.delete(opt); else selected.add(opt);
          b.classList.toggle('on');
        });
        chipsWrap.appendChild(b);
      }

      btnBack.style.display = (index>0)? '' : 'none';
      btnNext.style.display = (index<qty-1)? '' : 'none';
      btnOk.style.display   = (index===qty-1)? '' : 'none';
      btnSkip.style.display = 'none'; // no skip for condiments
      modal.classList.add('show');
    }

    btnBack.onclick=()=>{ index=Math.max(0,index-1); renderStep(); };
    btnNext.onclick=()=>{
      if(picks[index].size===0){ alert('Select at least 1.'); return; }
      index++; renderStep();
    };
    btnOk.onclick=()=>{
      if(picks[index].size===0){ alert('Select at least 1.'); return; }
      modal.classList.remove('show');
      resolve(picks.map(s=>Array.from(s)));
    };
    btnCancel.onclick=()=>{ modal.classList.remove('show'); resolve(null); };

    renderStep();
  });
}

/* ===== Cart modal ===== */
const drawer=$('#cartDrawer');
function showCart(){ drawer.classList.add('show'); }
function hideCart(){ drawer.classList.remove('show'); }
$('#cartBtn').onclick=showCart;
$('#closeCart').onclick=hideCart;

/* Clear & Submit */
$('#clearCart').onclick=()=>{ if(confirm('Clear cart?')){ cart=[]; renderCart(); } };

$('#submitOrder').onclick=()=>{
  const name = $('#custName').value.trim();
  if(!name){ alert('Please enter your name.'); $('#custName').focus(); return; }
  if(cart.length===0){ alert('Your cart is empty.'); return; }

  const total = cart.reduce((s,i)=>s+i.unitPrice*i.qty,0);
  const order = {
    id: crypto.randomUUID(),
    customer: name,
    items: cart.map(i=>({...i})),
    total,
    status:'Submitted',
    created_at: new Date().toISOString()
  };

  const existing = loadOrders(); existing.push(order); saveOrders(existing);

  cart=[]; renderCart(); hideCart(); $('#custName').value='';
  showToast('Order Submitted — Pay at Counter', 8000); // 8s
};

function loadOrders(){ try{ return JSON.parse(localStorage.getItem(ORDERS_KEY))||[] }catch{return []} }
function saveOrders(arr){ localStorage.setItem(ORDERS_KEY, JSON.stringify(arr)); }

/* ===== Toast ===== */
function showToast(message='Done', ms=3000){
  const t=$('#toast'); t.textContent = message; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), ms);
}

/* Init */
renderMenu();
renderCart();
</script>
</body>
</html>